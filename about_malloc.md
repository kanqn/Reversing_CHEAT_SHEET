### mallocの概要ざっくり
・malloc()ではプロセスのアドレス空間のうちヒープという領域を利用している  
  
・最初に特定のサイズのヒープ領域を空きプールとして確保する  
  
・空きプールが足りなくなるとsbrk()を使って現在のヒープ領域を拡張して補充していく  
  
・メモリプールは最初のmalloc()が呼ばれた時に確保される  
  
・malloc()はプロセスから要求されたサイズに応じてmalloc()の管理するchunk単位で、  
  確保したプールからメモリを切り出す  
    
・要求側にはchunkの管理部を除いた領域の先頭アドレスを返す  
  
・ヒープ領域以外にも条件によってはmmap()システムコールで確保した領域を利用する  
(どちらの領域を利用するかはプロセスから要求されたメモリサイズによって判断される)  
  
  
・free()で解放されるが、実際にはその時点でヒープ領域が減少する訳ではなく、  
未使用となったchunkは未使用リストにリンクされ管理され、次に要求があった時に必要に応じて再利用される  
・ただし永遠に解放されないわけではなく、一定の条件を満たした場合にはヒープ領域が減少される  
  
  
・メモリプール以外にメモリプール管理部をひとつのまとまりとした管理単位をmalloc()ではアリーナ(arena)と呼ぶ  

  
  
### メモリ管理部の構造
・arenaの管理部はmain_arenaという変数名で静的に定義されている  
(通常であればこの1つのarenaで十分)  
  
・複数arenaを使用する際に競合が生じないようにarena使用前後で排他制御を行っている  
また、main_arenaがロックされている場合はmalloc()は別のarenaを生成する  
この時のmain_arena以外のarenaはmmap()によって確保される  




### mallocが一定サイズの場合
#### free_list
・free_listは貸し出すためのメモリ空間をリスト構造で繋がった状態にしておく  
・mallocが呼び出される度にfree_listの先頭から貸し出すメモリを取り出す  
・freeで返却されたメモリは、free_listの先頭につないでおく<br>  
  
    
![free_list](https://www.ei.fukui-nct.ac.jp/wp-content/uploads/2018/01/2018-01-16-freelist.png)  

  
  
### 任意サイズのメモリ確保の場合
・貸し出されるメモリ空間には、ヒープメモリの利用者が使うブロックの前に、  
　次のメモリブロックへのポインタとブロックサイズを記憶する領域をつけておく。  
   
   
・こういったメモリブロックをfree_listの考え方と同じようにリスト構造となるようにつないで保存されている。  
  
  

![heap-malloc](https://www.ei.fukui-nct.ac.jp/wp-content/uploads/2018/01/2018-01-16-heap-malloc.png)

### free()の処理とメモリブロックの併合
・使用されていたメモリブロックがfree()で返却された場合は、free_listにつないでいく。　　

・free()で返却される際は、隣り合うメモリブロックと併合できるかを確認して大きなメモリブロックになるような処理を行う。
(この処理を行う理由は、malloc(),free()を繰り返した場合にと小さなメモリブロックになってしまい、大きなmallocができないため)  

・free_listにつなぐ際は、次のメモリブロックへのポインタは、昇順となるように並べられる。　　

