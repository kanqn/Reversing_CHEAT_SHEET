## mallocの概要ざっくり

・malloc()ではプロセスのアドレス空間のうちヒープという領域を利用している  
  
・最初に特定のサイズのヒープ領域を空きプールとして確保する  
  
・空きプールが足りなくなるとsbrk()を使って現在のヒープ領域を拡張して補充していく  
  
・メモリプールは最初のmalloc()が呼ばれた時に確保される  
  
・malloc()はプロセスから要求されたサイズに応じてmalloc()の管理するchunk単位で、  
  確保したプールからメモリを切り出す  
    
・要求側にはchunkの管理部を除いた領域の先頭アドレスを返す  
  
・ヒープ領域以外にも条件によってはmmap()システムコールで確保した領域を利用する  
(どちらの領域を利用するかはプロセスから要求されたメモリサイズによって判断される)  
  
  
・free()で解放されるが、実際にはその時点でヒープ領域が減少する訳ではなく、  
未使用となったchunkは未使用リストにリンクされ管理され、次に要求があった時に必要に応じて再利用される  
・ただし永遠に解放されないわけではなく、一定の条件を満たした場合にはヒープ領域が減少される  
  
  
・メモリプール以外にメモリプール管理部をひとつのまとまりとした管理単位をmalloc()ではアリーナ(arena)と呼ぶ  
  
  
  
  
  
  
## アリーナ(メモリ管理部)の構造について

・main_arenaは libc上に配置される構造体  
　→そのアドレスをリークすることで libc のアドレスのリークが可能！  

・arenaの管理部はmain_arenaという変数名で静的に定義されている  
(通常であればこの1つのarenaで十分)  
  
・複数arenaを使用する際に競合が生じないようにarena使用前後で排他制御を行っている  
また、main_arenaがロックされている場合はmalloc()は別のarenaを生成する  
この時のmain_arena以外のarenaはmmap()によって確保される  


### max fast
・fastbinsに登録するchunkの最大サイズで72byteになる  
・0ビット目はfastbinsにchunkが存在するかどうかのフラグになっている  
・マスクとしてFASTCHUNKS_BITを使用する  
  
### fastbins  
・単方向線形リスト  
・fastbinsは要求メモリを迅速に確保する為に用意されたchunkのリストヘッダ  
・free()で解放されるchunkの内、サイズがmax_fast以下のものはこのリストに登録される。  
  
登録先のインデックスを求める式:  
``` #define fastbin_index(sz) ((((unsigned int)(sz)) >> 3) – 2) ```  
  
・szは解放するchunkのサイズで、8バイト単位で拡張されるため、3ビットシフトする。  
・0ビット目がオンの場合は存在しない事を示し、chunk登録時にこれをオフとする。  
・chunk内の管理部は解放前の状態が保たれていて、  
　　これによってchunk確保時のchunk管理部設定の手間を省いている  


### top
・空きchunkの先頭アドレスを保持している  
  

### last_remainder
・既存の解放済みチャンクを分割した際、利用されなかった残りのチャンク１つの最新のアドレスを格納  
  
  
### bins
・解放されたmax_fastより上のサイズのchunkを登録するリストヘッダの配列で、  
　　fd(前)とbk(後)で一組になっている。  
  　また、binでは解放済みのチャンクをfdとdkを利用して双方向の循環リストに繋げ、管理している  
・binのサイズはNBINSの数値で決まり現在は128のため、256個の配列となっているが、  
　　fdとbkで一組になるため、128個のリストヘッダがあることになる。  
・fdとbkは共に管理するチャンクの先頭を指していて、  
　　チャンクのfdとbkは共にbin_at(n+1)の先頭をさしている  
・管理するチャンクが存在しないときは、自身のbinのみで循環リストを形成する  


### mallocが一定サイズの場合
#### free_list
・free_listは貸し出すためのメモリ空間をリスト構造で繋がった状態にしておく  
・mallocが呼び出される度にfree_listの先頭から貸し出すメモリを取り出す  
・freeで返却されたメモリは、free_listの先頭につないでおく<br>  
  
    
![free_list](https://www.ei.fukui-nct.ac.jp/wp-content/uploads/2018/01/2018-01-16-freelist.png)  

  
  
### 任意サイズのメモリ確保の場合
・貸し出されるメモリ空間には、ヒープメモリの利用者が使うブロックの前に、  
　次のメモリブロックへのポインタとブロックサイズを記憶する領域をつけておく。  
   
   
・こういったメモリブロックをfree_listの考え方と同じようにリスト構造となるようにつないで保存されている。  
  
  

![heap-malloc](https://www.ei.fukui-nct.ac.jp/wp-content/uploads/2018/01/2018-01-16-heap-malloc.png)

### free()の処理とメモリブロックの併合
・使用されていたメモリブロックがfree()で返却された場合は、free_listにつないでいく。　　

・free()で返却される際は、隣り合うメモリブロックと併合できるかを確認して大きなメモリブロックになるような処理を行う。
(この処理を行う理由は、malloc(),free()を繰り返した場合にと小さなメモリブロックになってしまい、大きなmallocができないため)  

・free_listにつなぐ際は、次のメモリブロックへのポインタは、昇順となるように並べられる。　　




## チャンクについて
・chunkサイズは8の倍数で作成される
・chunkの管理部を参照する際は-8バイトした場所を先頭としている
・sizeメンバはchunk全体のサイズでchunkのヘッダ部のサイズも含んでいる
・prev_sizeメンバはメモリ上で隣接する直前のchunkのサイズを格納する
・fd、bkはarenaのchunk管理部へ登録された場合の前後のchunkへのポインタを格納する  

### 未使用のチャンクについて
・未使用のchunkがある場合、メモリ上で直後にあるchunkのヘッダ部のprev_sizeメンバには、直前のchunkのサイズが設定されている  
  
### 使用中のチャンクについて
・使用中のchunkはarena管理部にチェーンされておりませんので、fd、bkは使用していない  
→そこでこの領域をユーザー領域として利用する！  
（また、直前のchunkが使用中の場合はprev_sizeも未使用になるため、同様にユーザー領域として使用される）  
  
  
  
  
### unsorted_chunks  
・fastbinsよりも大きいサイズの解放chunkである場合はここに一旦登録される  
・サイズ毎のbinsに再登録されるときまではここに保存される  
#### unsorted_chunksへの登録  
IS_MAPPEDがオフの場合に以下の処理を行うことができる  
##### 直後のchunkがav->topでない時
・直前のchunkが未使用の場合、直前のchunkをリストから外し結合  
・直後のchunkが使用中ならば、直後のchunkのPREV_INUSEをオフ  
・解放chunkをunsorted_chunksに登録、ヘッダーの更新  
  
  
##### 直後のchunkがav->top時  
・topのchunkと結合し、av->topをpで更新  

